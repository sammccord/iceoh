"use strict";var x=Object.defineProperty;var m=(a,e,i)=>e in a?x(a,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):a[e]=i;var o=(a,e,i)=>(m(a,typeof e!="symbol"?e+"":e,i),i);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const h=require("./utils.umd.js");class c{constructor({worldOrigin:e,baseTileOrigin:i,baseTileDimensions:t,getScreenDimensions:s,getWorldPosition:r,getWorldScale:n}={}){o(this,"getScreenDimensions");o(this,"getWorldPosition");o(this,"getWorldScale");o(this,"baseTileDimensions");o(this,"worldOrigin",h.MIDDLE);o(this,"baseTileOrigin",h.MIDDLE);o(this,"map",new Map);o(this,"bounds",{x:{min:0,max:0},y:{min:0,max:0},z:{min:0,max:0}});this.worldOrigin=e||h.MIDDLE,this.baseTileOrigin=i||h.MIDDLE,this.baseTileDimensions=t||{width:1,height:1},this.getScreenDimensions=s||(()=>({width:1,height:1})),this.getWorldPosition=r||(()=>h.TOP_LEFT),this.getWorldScale=n||(()=>h.FULL)}add(e,i,t=this.baseTileDimensions,s=this.baseTileOrigin){return h.set(this.map,[i.z||0,i.x,i.y],e),this.recalculateBounds(i),this.toWorldPoint(i,t,s)}addMany(e,i=this.baseTileDimensions,t=this.baseTileOrigin){return e.map(([s,r])=>this.add(s,r,i,t))}set(e,i){return h.set(this.map,[i.z||0,i.x,i.y],e),this.recalculateBounds(i),()=>this.remove(i)}setMany(e){return e.map(([i,t])=>this.set(i,t))}get(e){return h.pointGet(this.map,e)}getColumn(e,i){const t=[];for(const[s,r]of i||this.map)t[s]=h.get(r,[e.x,e.y]);return t}move(e,i,t=this.baseTileDimensions,s=this.baseTileOrigin,r){const n=this.remove(e);if(!(!n||!r))return this.add(n||r,i,t,s)}remove(e){e.z===void 0&&(e.z=0);const i=this.get(e);if(!!i)return h.remove(this.map,[e.z||0,e.x,e.y]),this.recalculateBounds(e),i}toScreenPoint(e,i=this.baseTileDimensions,t=this.baseTileOrigin){const s=this.toWorldPoint(e,i,t),r=this.getWorldScale(),n=this.getWorldPosition();return s.x=s.x*r.x+n.x,s.y=s.y*r.y+n.y,s}toWorldPoint(e,i=this.baseTileDimensions,t=this.baseTileOrigin){return this.screenProject(this.getAbsolutePosition(e),i,t)}worldToTile(e,i=this.baseTileDimensions,t=this.baseTileOrigin){const s=this.screenUnproject(e);return{x:Math.round(s.x/i.width),y:Math.round(s.y/i.height),z:e.z||0}}centerToTile(e){return this.centerToPoint(this.toScreenPoint(e))}centerToPoint(e){const i=this.getScreenDimensions(),t=this.getWorldPosition();return{x:t.x+i.width/2-e.x,y:t.y+i.height/2-e.y}}get centerTile(){return this.getBounds()}center(){return this.centerToTile(this.centerTile)}getBounds(){const e={x:0,y:0,width:this.bounds.x.max-this.bounds.x.min,height:this.bounds.y.max-this.bounds.y.min,depth:this.bounds.z.max-this.bounds.z.min,z:0};return e.x=Math.round(this.bounds.x.min+e.width/2),e.y=Math.round(this.bounds.y.min+e.height/2),e}each(e){for(const[i,t]of this.map)for(const[s,r]of t)for(const[n,l]of r)if(e(l,{x:s,y:n,z:i})===!1)return}within(e,i,t){for(let s=e.z||0;s<(i.z||1);s++){const r=this.map.get(s);for(let n=e.x;n<=i.x;n++){const l=r&&r.get(n);for(let d=e.y;d<=i.y;d++){const u=l&&l.get(d);if(t(u,{x:n,y:d,z:s})===!1)return}}}}neighbors(e,i){this.within({x:e.x-1,y:e.y-1,z:e.z||0},{x:e.x+1,y:e.y+1,z:e.z||0},(t,s)=>{if(!(s.x===e.x&&s.y===e.y&&s.z===(e.z||0)))return i(t,s)})}around(e,i,t,s){this.within({x:e.x-i,y:e.y-i,z:e.z||0},{x:e.x+i,y:e.y+i,z:e.z||0},(r,n)=>{if(!(n.x===e.x&&n.y===e.y&&n.z===(e.z||0))&&t(r,n)!==!1)return s(r,n)})}recalculateBounds(e){e.x<this.bounds.x.min&&(this.bounds.x.min=e.x),e.x>this.bounds.x.max&&(this.bounds.x.max=e.x),e.y<this.bounds.y.min&&(this.bounds.y.min=e.y),e.y>this.bounds.y.max&&(this.bounds.y.max=e.y),e.z!==void 0&&(e.z<this.bounds.z.min&&(this.bounds.z.min=e.z),e.z>this.bounds.z.max&&(this.bounds.z.max=e.z))}project(e,i=this.baseTileDimensions,t=this.baseTileOrigin,s=0){return{x:e.x,y:e.y,z:e.z||0}}screenProject(e,i=this.baseTileDimensions,t=this.baseTileOrigin,s=0){const{width:r,height:n}=this.getScreenDimensions();return{x:e.x+r*this.worldOrigin.x,y:e.y+n*this.worldOrigin.y,z:e.z||0}}unproject(e,i={x:0,y:0,z:0}){return i.x=e.x,i.y=e.y+(e.z||0),i.z=e.z||0,i}screenUnproject(e,i={x:0,y:0,z:0}){const{width:t,height:s}=this.getScreenDimensions();return i.x=e.x-t*this.worldOrigin.x,i.y=e.y-s*this.worldOrigin.y+(e.z||0),i.z=e.z||0,i}getAbsolutePosition(e,i=this.baseTileDimensions,t=this.baseTileOrigin){return{x:i.width*e.x,y:i.height*e.y,z:e.z||0}}}exports.Tilemap=c;
