"use strict";var x=Object.defineProperty;var m=(a,i,e)=>i in a?x(a,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[i]=e;var o=(a,i,e)=>(m(a,typeof i!="symbol"?i+"":i,e),e);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const h=require("./utils.umd.js");class g{constructor({worldOrigin:i,baseTileOrigin:e,baseTileDimensions:t,getScreenDimensions:s,getWorldPosition:r,getWorldScale:n}={}){o(this,"getScreenDimensions");o(this,"getWorldPosition");o(this,"getWorldScale");o(this,"baseTileDimensions");o(this,"worldOrigin",h.MIDDLE);o(this,"baseTileOrigin",h.MIDDLE);o(this,"map",new Map);o(this,"bounds",{x:{min:0,max:0},y:{min:0,max:0},z:{min:0,max:0}});this.worldOrigin=i||h.MIDDLE,this.baseTileOrigin=e||h.MIDDLE,this.baseTileDimensions=t||{width:1,height:1},this.getScreenDimensions=s||(()=>({width:1,height:1})),this.getWorldPosition=r||(()=>h.TOP_LEFT),this.getWorldScale=n||(()=>h.FULL)}add(i,e,t=this.baseTileDimensions,s=this.baseTileOrigin){return h.set(this.map,[e.z||0,e.x,e.y],i),this.recalculateBounds(e),this.toWorldPoint(e,t,s)}addMany(i,e=this.baseTileDimensions,t=this.baseTileOrigin){return i.map(([s,r])=>this.add(s,r,e,t))}set(i,e){return h.set(this.map,[e.z||0,e.x,e.y],i),this.recalculateBounds(e),()=>this.remove(e)}setMany(i){return i.map(([e,t])=>this.set(e,t))}get(i){return h.pointGet(this.map,i)}getColumn(i,e){const t=[];for(const[s,r]of e||this.map)t[s]=h.get(r,[i.x,i.y]);return t}move(i,e,t=this.baseTileDimensions,s=this.baseTileOrigin,r){const n=this.remove(i);if(!(!n||!r))return this.add(n||r,e,t,s)}remove(i){i.z===void 0&&(i.z=0);const e=this.get(i);if(!!e)return h.remove(this.map,[i.z||0,i.x,i.y]),this.recalculateBounds(i),e}toScreenPoint(i,e=this.baseTileDimensions,t=this.baseTileOrigin){const s=this.toWorldPoint(i,e,t),r=this.getWorldScale(),n=this.getWorldPosition();return s.x=s.x*r.x+n.x,s.y=s.y*r.y+n.y,s}toWorldPoint(i,e=this.baseTileDimensions,t=this.baseTileOrigin){return this._project(this._getAbsolutePosition(i),e,t)}worldToTile(i,e=this.baseTileDimensions,t=this.baseTileOrigin){const s=this._unproject(i);return{x:Math.round(s.x/e.width),y:Math.round(s.y/e.height),z:i.z||0}}centerToTile(i){return this.centerToPoint(this.toScreenPoint(i))}centerToPoint(i){const e=this.getScreenDimensions(),t=this.getWorldPosition();return{x:t.x+e.width/2-i.x,y:t.y+e.height/2-i.y}}get centerTile(){return this.getBounds()}center(){return this.centerToTile(this.centerTile)}getBounds(){const i={x:0,y:0,width:this.bounds.x.max-this.bounds.x.min,height:this.bounds.y.max-this.bounds.y.min,depth:this.bounds.z.max-this.bounds.z.min};return i.x=Math.round(this.bounds.x.min+i.width/2),i.y=Math.round(this.bounds.y.min+i.height/2),i}each(i){for(const[e,t]of this.map)for(const[s,r]of t)for(const[n,l]of r)if(i(l,{x:s,y:n,z:e})===!1)return}within(i,e,t){for(let s=i.z||0;s<(e.z||1);s++){const r=this.map.get(s);for(let n=i.x;n<=e.x;n++){const l=r&&r.get(n);for(let u=i.y;u<=e.y;u++){const d=l&&l.get(u);if(t(d,{x:n,y:u,z:s})===!1)return}}}}neighbors(i,e){this.within({x:i.x-1,y:i.y-1,z:i.z||0},{x:i.x+1,y:i.y+1,z:i.z||0},(t,s)=>{if(!(s.x===i.x&&s.y===i.y&&s.z===(i.z||0)))return e(t,s)})}around(i,e,t,s){this.within({x:i.x-e,y:i.y-e,z:i.z||0},{x:i.x+e,y:i.y+e,z:i.z||0},(r,n)=>{if(!(n.x===i.x&&n.y===i.y&&n.z===(i.z||0))&&t(r,n)!==!1)return s(r,n)})}recalculateBounds(i){i.x<this.bounds.x.min&&(this.bounds.x.min=i.x),i.x>this.bounds.x.max&&(this.bounds.x.max=i.x),i.y<this.bounds.y.min&&(this.bounds.y.min=i.y),i.y>this.bounds.y.max&&(this.bounds.y.max=i.y),i.z!==void 0&&(i.z<this.bounds.z.min&&(this.bounds.z.min=i.z),i.z>this.bounds.z.max&&(this.bounds.z.max=i.z))}_project(i,e=this.baseTileDimensions,t=this.baseTileOrigin,s=0){const{width:r,height:n}=this.getScreenDimensions();return{x:i.x+r*this.worldOrigin.x,y:i.y+n*this.worldOrigin.y,z:i.z||0}}_unproject(i,e={x:0,y:0,z:0}){const{width:t,height:s}=this.getScreenDimensions();return e.x=i.x-t*this.worldOrigin.x,e.y=i.y-s*this.worldOrigin.y+(i.z||0),e.z=i.z||0,e}_getAbsolutePosition(i,e=this.baseTileDimensions,t=this.baseTileOrigin){return{x:e.width*i.x,y:e.height*i.y,z:i.z||0}}}exports.Tilemap=g;
