(function(o,c){typeof exports=="object"&&typeof module<"u"?c(exports):typeof define=="function"&&define.amd?define(["exports"],c):(o=typeof globalThis<"u"?globalThis:o||self,c(o.Iceoh={}))})(this,function(o){"use strict";var k=Object.defineProperty;var F=(o,c,x)=>c in o?k(o,c,{enumerable:!0,configurable:!0,writable:!0,value:x}):o[c]=x;var a=(o,c,x)=>(F(o,typeof c!="symbol"?c+"":c,x),x);const c=Math.atan(.5),x=Math.PI/6,C=Math.PI/4,M={x:0,y:0},T={x:.5,y:.5},P={x:1,y:1};var v=(r=>(r.NONE="NONE",r.N="N",r.NE="NE",r.E="E",r.SE="SE",r.S="S",r.SW="SW",r.W="W",r.NW="NW",r))(v||{});function j(r){const s=[];for(const e of Array.from(r.keys()).sort()){const i=r.get(e);for(const t of Array.from(i.keys()).sort()){const n=i.get(t);for(const h of Array.from(n.keys()).sort())s.push(n.get(h))}}return s}function g(r,s,e){let i=r;for(;s.length-1;){var t=s.shift();let n=i.get(t);if(n)i=n;else{const h=new Map;i.set(t,h),i=h}}return i.set(s[0],e),e}function w(r,s,e){for(var i=r;s.length;){var t=s.shift();let n=i.get(t);if(!n){if(e&&!s.length)return i.set(t,e),e;if(e)n=new Map,i.set(t,n);else return}i=n}return i}function W(r,s){return w(r,[s.z||0,s.x,s.y])}function S(r,s){let e=r;for(;s.length-1;){var i=s.shift();let t=e.get(i);if(t)e=t;else return!1}return e.delete(s[0])}function H(r,s){return Math.sqrt((s.x-r.x)*(s.x-r.x)+(s.y-r.y)*(s.y-r.y))}function _(r){return r.reduce((s,e)=>e?s+e:s,0)}const u=0;function B(r,s){let e=s.x-r.x,i=s.y-r.y;return e===u&&i<u?"N":e>u&&i<u?"NE":e>u&&i===u?"E":e>u&&i>u?"SE":e===u&&i>u?"S":e<u&&i>u?"SW":e<u&&i===u?"W":e<u&&i<u?"NW":"NONE"}class E{constructor({worldOrigin:s,baseTileOrigin:e,baseTileDimensions:i,getScreenDimensions:t,getWorldPosition:n,getWorldScale:h}){a(this,"getScreenDimensions");a(this,"getWorldPosition");a(this,"getWorldScale");a(this,"baseTileDimensions");a(this,"worldOrigin",T);a(this,"baseTileOrigin",T);a(this,"map",new Map);a(this,"bounds",{x:{min:0,max:0},y:{min:0,max:0},z:{min:0,max:0}});this.worldOrigin=s||T,this.baseTileOrigin=e||T,this.baseTileDimensions=i,this.getScreenDimensions=t,this.getWorldPosition=n||(()=>M),this.getWorldScale=h||(()=>P)}add(s,e,i=this.baseTileDimensions,t=this.baseTileOrigin){return g(this.map,[e.z||0,e.x,e.y],s),this.recalculateBounds(e),this.toWorldPoint(e,i,t)}get(s){return W(this.map,s)}getColumn(s,e){const i=[];for(const[t,n]of e||this.map)i[t]=w(n,[s.x,s.y]);return i}move(s,e,i=this.baseTileDimensions,t=this.baseTileOrigin){const n=this.remove(s);return n?this.add(n,e,i,t):null}remove(s){s.z===void 0&&(s.z=0);const e=this.get(s);if(!!e)return S(this.map,[s.z||0,s.x,s.y]),this.recalculateBounds(s),e}toScreenPoint(s,e=this.baseTileDimensions,i=this.baseTileOrigin){const t=this.toWorldPoint(s,e,i),n=this.getWorldScale(),h=this.getWorldPosition();return t.x=t.x*n.x+h.x,t.y=t.y*n.y+h.y,t}toWorldPoint(s,e=this.baseTileDimensions,i=this.baseTileOrigin){return this._project(this._getAbsolutePosition(s),e,i)}worldToTile(s,e=this.baseTileDimensions,i=this.baseTileOrigin){const t=this._unproject(s);return{x:Math.round(t.x/e.width),y:Math.round(t.y/e.height),z:s.z||0}}centerToTile(s){return this.centerToPoint(this.toScreenPoint(s))}centerToPoint(s){const e=this.getScreenDimensions(),i=this.getWorldPosition();return{x:i.x+e.width/2-s.x,y:i.y+e.height/2-s.y}}get centerTile(){return this.getBounds()}center(){return this.centerToTile(this.centerTile)}getBounds(){const s={x:0,y:0,width:this.bounds.x.max-this.bounds.x.min,height:this.bounds.y.max-this.bounds.y.min,depth:this.bounds.z.max-this.bounds.z.min};return s.x=Math.round(this.bounds.x.min+s.width/2),s.y=Math.round(this.bounds.y.min+s.height/2),s}recalculateBounds(s){s.x<this.bounds.x.min&&(this.bounds.x.min=s.x),s.x>this.bounds.x.max&&(this.bounds.x.max=s.x),s.y<this.bounds.y.min&&(this.bounds.y.min=s.y),s.y>this.bounds.y.max&&(this.bounds.y.max=s.y),s.z!==void 0&&(s.z<this.bounds.z.min&&(this.bounds.z.min=s.z),s.z>this.bounds.z.max&&(this.bounds.z.max=s.z))}_project(s,e=this.baseTileDimensions,i=this.baseTileOrigin,t=0){const{width:n,height:h}=this.getScreenDimensions();return{x:s.x+n*this.worldOrigin.x,y:s.y+h*this.worldOrigin.y,z:s.z||0}}_unproject(s,e={x:0,y:0,z:0}){const{width:i,height:t}=this.getScreenDimensions();return e.x=s.x-i*this.worldOrigin.x,e.y=s.y-t*this.worldOrigin.y+(s.z||0),e.z=s.z||0,e}_getAbsolutePosition(s,e=this.baseTileDimensions,i=this.baseTileOrigin){return{x:e.width*s.x,y:e.height*s.y,z:s.z||0}}}class N extends E{constructor({angle:e=c,clamp:i=!0,...t}){super({...t});a(this,"angle");a(this,"angleCos");a(this,"angleSin");a(this,"clamp");a(this,"baseOrigin");a(this,"baseSurfaceHeight");a(this,"baseSurfaceHalfHeight");a(this,"tileDimensions",new Map);this.angle=e,this.angleCos=Math.cos(this.angle),this.angleSin=Math.sin(this.angle),this.clamp=i,this.baseOrigin={x:this.baseTileDimensions.width*this.baseTileOrigin.x,y:this.baseTileDimensions.height*this.baseTileOrigin.y},this.baseSurfaceHeight=this.baseTileDimensions.height-this.baseTileDimensions.depth,this.baseSurfaceHalfHeight=this.baseSurfaceHeight/2}add(e,i,t=this.baseTileDimensions,n=this.baseTileOrigin){const h=this.toWorldPoint(i,t,n);if(t!==this.baseTileDimensions){let d=(t.depth||this.baseTileDimensions.depth)/this.baseTileDimensions.depth;for(let l=d,y=i.z||0;l>0;l--,y++)l>1?g(this.tileDimensions,[y,i.x,i.y],{...t,origin:n,depth:this.baseTileDimensions.depth,z:y,x:h.x,y:h.y,value:e}):g(this.tileDimensions,[y,i.x,i.y],{...t,origin:n,depth:this.baseTileDimensions.depth*l,z:y,x:h.x,y:h.y,value:e}),g(this.map,[y,i.x,i.y],i)}else g(this.tileDimensions,[i.z||0,i.x,i.y],{...t,origin:n,z:i.z||0,x:h.x,y:h.y,value:e}),g(this.map,[i.z||0,i.x,i.y],i);return this.recalculateBounds(i),h}remove(e){const i=this.get(e);if(!i)return null;for(const[t,n]of this.map)try{w(n,[e.x,e.y])===i&&(S(this.tileDimensions,[t,e.x,e.y]),S(this.map,[t,e.x,e.y]))}catch{}return this.recalculateBounds(e),i}worldToTile(e,i=this.baseTileDimensions,t=this.baseTileOrigin){const n=this._unproject(e),h={x:i.width*t.x,y:i.width*t.y};return n.x=Math.floor((n.x+h.x)/h.x),n.y=Math.floor((n.y+h.y)/h.y),n.z=n.z||0,n}toWorldPoint(e,i=this.baseTileDimensions,t=this.baseTileOrigin){return this._project(this._getAbsolutePosition(e),i,t,_(this.getDimensionsColumn(e).map(n=>(n==null?void 0:n.depth)||this.baseTileDimensions.depth).slice(1,e.z||0)))}getDimensionsColumn(e){return this.getColumn(e,this.tileDimensions)}castRay(e,i){const t=this.worldToTile(e);for(let n=this.bounds.z.max;n>=this.bounds.z.min;n--){const h=t.x+n,d=t.y+n;for(let l of this.getDimensionsColumn({x:h,y:d}).reverse()){if(!l)continue;const{x:y,y:z,value:f,origin:m,width:D,height:O,tile:b}=l;if(e.x>=y-D*m.x&&e.x<=y+D*m.x&&e.y>=z-O*m.y&&e.y<=z+O*m.y)if(i){if(i(f,b))return f}else return f}}}collisionMap(e,i){const t=new Map,n=this.worldToTile(e);for(let h=this.bounds.z.min;h<=this.bounds.z.max;h++){let d=!1;const l=n.x+h,y=n.y+h;for(let z of this.getDimensionsColumn({x:l,y})){if(!z)continue;const{x:f,y:m,value:D,z:O,origin:b,width:L,height:A,tile:Y}=z;if(e.x>=f-L*b.x&&e.x<=f+L*b.x&&e.y>=m-A*b.y&&e.y<=m+A*b.y){if(i&&!i(D,Y))continue;d=!0,g(t,[O,l,y],D)}else if(d)break}}return t}_project(e,i=this.baseTileDimensions,t=this.baseTileOrigin,n=0){const{width:h,height:d}=this.getScreenDimensions(),l={x:(e.x-e.y)*this.angleCos+h*this.worldOrigin.x,y:(e.x+e.y)*this.angleSin+d*this.worldOrigin.y,z:(e.x+e.y)*(e.z+1||1)};return i!==this.baseTileDimensions?(l.y-=this.baseSurfaceHalfHeight+0-this.baseTileOrigin.y,l.y+=i.height*t.y-(i.height-(i.height-i.depth)/2),l.y-=n):l.y-=this.baseTileDimensions.depth*e.z,this.clamp&&(l.x=~~(l.x+(l.x>0?.5:-.5)),l.y=~~(l.y+(l.y>0?.5:-.5))),l}_unproject(e,i={x:0,y:0,z:0}){const t=this.getScreenDimensions(),n=e.x-t.width*this.worldOrigin.x,h=e.y-t.height*this.worldOrigin.y;return i.x=n/(2*this.angleCos)+h/(2*this.angleSin),i.y=-(n/(2*this.angleCos))+h/(2*this.angleSin),i.z=e.z||0,i}_getAbsolutePosition(e,i=this.baseTileDimensions,t=this.baseTileOrigin){return{x:i.width*t.x*e.x,y:i.height*t.y*e.y,z:e.z||0}}}o.CLASSIC=c,o.DIRECTION=v,o.FULL=P,o.ISOMETRIC=x,o.IsoTilemap=N,o.MIDDLE=T,o.MILITARY=C,o.TOP_LEFT=M,o.Tilemap=E,o.collectRay=j,o.get=w,o.getDirection=B,o.getDistance=H,o.pointGet=W,o.remove=S,o.set=g,o.sum=_,Object.defineProperties(o,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
